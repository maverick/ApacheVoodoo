#!/usr/bin/perl -I /data/apache/lib/perl

=pod ####################################################################################

=head1 NAME

voodoo-control - install / upgrade 

=head1 VERSION

$Id: Handler.pm 2597 2005-09-15 16:33:41Z medwards $

=head1 SYNOPSIS

FIXME: Add documentation

=cut ####################################################################################

use Apache::Voodoo::Constants;
use Apache::Voodoo::Install::Updater;

use DBI;
use Getopt::Long;

use Data::Dumper;

use strict;
use warnings;

# turn off buffered output
$| = 1;

my $pretend = 0;
my $help    = 0;
my ($dbhost,$dbname,$dbuser,$dbpass,$dbroot);

my %defaults = (
	'PREFIX'     => '/data/apache',
	'SBINDIR'    => '/data/apache/bin',
	'SYSCONFDIR' => '/data/apache/conf'
);

GetOptions(
	'help'        => \$help,
	'pretend'     => \$pretend,
	'verbose|v:s' => \$verbose,
	'dbhost|h:s'  => \$dbhost,
	'dbname|n:s'  => \$dbname,
	'dbuser|u:s'  => \$dbuser,
	'dbpass|p:s'  => \$dbpass,
	'dbroot|r:s'  => \$dbroot
);

show_usage() if $help;

my $constants = Apache::Voodoo::Constants->new();

my ($command,$path) = @ARGV;

if ($command eq "install") {
	################################################################################
	# make sure this file exists and that the name follows the correct format
	################################################################################
	my $installer = Apache::Voodoo::Installer->new(
		'verbose' => 4,
		'pretend' => $pretend,
		'dbhost'  => $dbhost,
		'dbname'  => $dbname,
		'dbpass'  => $dbpass,
		'dbroot'  => $dbroot,
		%defaults
	);

	################################################################################
	# unpack and verify the distribution
	################################################################################
	my ($unpack_dir,$app_name) = $installer->unpack_distribution($distribution);

	$installer->check_distribution($unpack_dir,$app_name);

	################################################################################
	# Let's see if we're upgrading an existing app.
	################################################################################
	my $has_existing = $installer->check_existing();

}
elsif ($command eq "update") {
	my $conf_file = $path."/".$constants->conf_file();

	unless (-e $conf_file) {
		print "Can't open configuration file: $conf_file\n";
		exit;
	}

	my %conf = ParseConfig($conf_file);

	my @dbdata = (
			$conf{'database'}->{'connect'},
			$conf{'database'}->{'username'},
			$conf{'database'}->{'password'}
	);

	my $dbh = DBI->connect(@dbdata) || die DBI->errstr;

	my $updater = Apache::Voodoo::Install::Updater->new(
			dbh      => $dbh,
			path     => $path,
			verbose  => $verbose,
			pretend  => $pretend
	);

	$updater->do_update();
}
else {
	show_usage();
}
	
sub show_usage {
	print "\nAutomated install / upgrade for Apache::Voodoo based applications.\n\n";
	print "Usage: voodoo-control [options] [install \"installfile\"|update \"application root\"]\n";
	print "    --pretend    Step through operations.  Don't actually do anything\n";
	print "    -h --dbhost  Override database host name in config files\n";
	print "    -n --dbname  Override database name in conf files\n";
	print "    -u --dbuser  Override database username in conf files\n";
	print "    -p --dbpass  Override database password in conf files\n";
	print "    -r --dbroot  Database root password\n";
	print "\n";
	exit;
}

$installer->prepare_setup_commands();
$installer->install_files();
$installer->update_conf_file();
$installer->post_setup_checks();
$installer->execute_setup_commands();

$installer->cleanup();

=pod ################################################################################

=head1 AUTHOR

Maverick, /\/\averick@smurfbaneDOTorg

=head1 COPYRIGHT

Copyright (c) 2005 Steven Edwards.  All rights reserved.

You may use and distribute Voodoo under the terms described in the LICENSE file include
in this package or L<Apache::Voodoo::license>.  The summary is it's a legalese version
of the Artistic License :)

=cut ################################################################################
